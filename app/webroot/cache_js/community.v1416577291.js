var COMMUNITY_TYPE_OPEN=1,COMMUNITY_TYPE_CLOSE=2,COMMUNITY_TYPE_SITE=3;
$(document).ready(function(){$("#community_type_help").popover({placement:"right",trigger:"hover focus",title:"Community type",html:!0,container:"#community_type_popover"});$("input#CommunityTags").tagsinput({confirmKeys:[13,32]});initCommunityPhotoUploader();var a=$("#communityWizard").wizard();a.on("change",function(a,e){if("undefined"!=typeof e&&"next"==e.direction){2===e.step&&handleCountryZipValidation($("#CommunityCountry"));if(!$(form).valid())return!1;$("#diagnosis_form_container .no_result_msg").hide()}});
a.on("finished",function(){$(form).valid()&&($(form).submit(),a.find("button").attr("disabled","disabled"))});a.on("changed",function(){window.scrollTo(0,0)})});$(document).on("click","#cancel_community_wizard, #close_community_wizard",function(){var a=$(form).data("backurl");window.location.href=a});
$(document).on("click","#add_diagnosis_btn",function(){var a=$("#diagnosis_last_index").val(),b=parseInt(a)+1,a=$("#sample_diagnosis_record").clone();a.removeClass("hide").removeAttr("id");a.find("input").each(function(){var a=$(this).attr("name"),d=$(this).attr("id"),a=a.replace("index",b),d=d.replace("Index",b);$(this).attr("name",a);$(this).attr("id",d)});$("#diagnosis_form_container").append(a);$("#diagnosis_last_index").val(b)});
$(document).on("focus",".disease_search",function(){initDiseaseAutoComplete(this,2)});$(document).on("click","#delete_community_button",function(a){a.preventDefault();var b=$(this).attr("href");bootbox.confirm("On deleting the community, all the posts and events will be deleted. Are you sure you want to delete?",function(a){a&&window.location.replace(b)})});
function initCommunityPhotoUploader(){$uploadBtn=$("#bootstrapped-fine-uploader");$previewImg=$("#uploadPreview img#preview_image");$previewLoadingImg=$("#uploadPreview img#loading_img");var a=new qq.FineUploaderBasic({button:$uploadBtn[0],debug:!1,multiple:!1,request:{endpoint:"/community/add/uploadPhoto"},validation:{acceptFiles:"image/*",allowedExtensions:app.imageExtensions,minSizeLimit:"1024",sizeLimit:"5242880"},callbacks:{onError:function(a,b,c){showUploadError(c);$uploadBtn.show();$("#btn_community_wizard_stop1").prop("disabled",
!1)},onSubmit:function(){$uploadBtn.hide()},onUpload:function(a,b){showUploadLoadingMessage("Uploading \u201c"+b+"\u201d ");$("#btn_community_wizard_stop1").prop("disabled",!0)},onProgress:function(a,b,c,g){c<g&&(a=Math.round(100*(c/g))+"% of "+Math.round(g/1024)+" kB",showUploadLoadingMessage("Uploading \u201c"+b+"\u201d "+a))},onComplete:function(d,j,c){$("#btn_community_wizard_stop1").prop("disabled",!1);$uploadBtn.show();c.success?(hideUploadMessage(),d='<div class="crop_area"><img src="'+c.fileUrl+
'" alt="Uploaded photo" /></div>',b=bootbox.dialog({closeButton:!1,message:d+'<div>To make adjustments, please drag around the white rectangle. When you are happy with the photo, click "Accept" button.</div>',title:"Crop Image",animate:!1,buttons:{success:{label:"Accept",className:"accept btn-success",callback:function(){var a=e.getSelection(!1);$.ajax({dataType:"json",type:"POST",url:"/community/add/cropImage",beforeSend:function(){$previewLoadingImg.removeClass("hide");$previewImg.hide()},data:{x1:a.x1,
y1:a.y1,w:a.width,h:a.height,fileName:c.fileName},success:function(a){$("#CommunityImage").val(a.fileName);var b=(new Date).getTime();$previewImg.attr("src",a.fileUrl+"?"+b);$previewImg.load(function(){$previewLoadingImg.addClass("hide");$previewImg.fadeIn()})}})}},cancel:{label:"Cancel",className:"btn-default",callback:function(){a.cancelAll();hideUploadMessage()}}}}),b.find(".modal-footer .btn-success").attr("disabled","disabled"),setTimeout(function(){var a=b,d=a.find(".bootbox-body img");srcWidth=
c.imageWidth;srcHeight=c.imageHeight;var f=["240 "," 106"],h=f[0],f=f[1],i=Math.min(Math.floor(srcWidth/h),Math.floor(srcHeight/f));e=d.imgAreaSelect({parent:".bootbox",autoHide:!1,mustMatch:!0,handles:!0,instance:!0,imageWidth:srcWidth,imageHeight:srcHeight,aspectRatio:"240 : 106",x1:0,y1:0,x2:i*h,y2:i*f,onInit:function(){a.find(".modal-footer .btn-success").removeAttr("disabled")},onSelectStart:function(){a.find(".modal-footer .btn-success").removeAttr("disabled")},onCancelSelection:function(){a.find(".modal-footer .btn-success").attr("disabled",
"disabled")}})},500)):c.error?showUploadError("Error with \u201c"+j+"\u201d: "+c.error):showUploadError("Failed to upload photo.")}}}),b,e}$messages=$("#uploadmessages");$loadingImg='<img src="/img/loading.gif" /> ';function showUploadError(a){$messages.html(a);$messages.removeClass("alert-info").addClass("alert-error").show();$messages.parent().removeClass("upload_progress")}
function showUploadLoadingMessage(a){$messages.html($loadingImg+a);$messages.removeClass("alert-error").addClass("alert-info").show();$messages.parent().addClass("upload_progress")}function hideUploadMessage(){$messages.html("").hide();$messages.parent().removeClass("upload_progress")}
function setUserStatus(a,b,e){bootbox.confirm(1==e?"Are you sure you want to leave the community?":"Are you sure you want to join the community?",function(d){d&&(Ladda.create(document.querySelector("#status")).start(),$.ajax({type:"POST",url:"/community/details/setUserStatus",data:{communityId:a,userId:b,status:e},success:function(){location.reload()}}))})}
$(document).on("click","#approve_invitation_btn",function(){Ladda.create(this).start();var a=$(this).closest("form").find("#community_id").val();$("#reject_invitation_btn").attr("disabled","disabled");$.ajax({type:"POST",url:"/community/details/approveInvitation",data:{communityId:a},success:function(){location.reload()}})});
$(document).on("click","#reject_invitation_btn",function(){Ladda.create(this).start();var a=$(this).closest("form").find("#community_id").val();$("#approve_invitation_btn").attr("disabled","disabled");$.ajax({type:"POST",url:"/community/details/rejectInvitation",data:{communityId:a},success:function(){location.reload()}})});
$(document).on("change","#CommunityType",function(){parseInt($(this).val())===COMMUNITY_TYPE_SITE?($("#diagnosis_error").addClass("hide").hide(),$("#diagnosis_error").closest(".form-group").removeClass("error"),$("#community_wizard_step3_common").addClass("hide"),$("#community_wizard_step3_sitewide").removeClass("hide")):($("#community_wizard_step3_common").removeClass("hide"),$("#community_wizard_step3_sitewide").addClass("hide"))});