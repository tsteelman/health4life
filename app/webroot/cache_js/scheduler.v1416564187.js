$(document).on("click","#add_medication_btn",function(){clearMedicationScheduleForm();var a=$("#hidden_medication_data_form").find("#selected_date").val();$("#MedicationSchedulerFormSelectedDate").val(a);$("#medication_scheduler_dialog").find(".modal-title.add_title").removeClass("hide");$("#medication_scheduler_dialog").find(".modal-title.edit_title").addClass("hide");$("#medication_scheduler_dialog").modal("show")});
function clearMedicationScheduleForm(){$("#medication_scheduler_form")[0].reset();$("#medication_scheduler_form").find("span.help-block").html("").hide();$("#medication_scheduler_form").find(".form-group, .form-group-col").removeClass("error");$("#medication_time_error").show().addClass("hide");$("#selected_times").html("").removeClass("facelist");$("#MedicationSchedulerFormEndDate").prop("disabled",!0);$("#last_time_row_index").val("");$("#MedicationSchedulerFormRepeatFrequency").val("DAILY:1");
$("#save_medication_schedule").prop("disabled",!1);$("#cancel_medication_schedule").prop("disabled",!1);var a=getUserNow();$("#MedicationSchedulerFormStartYear").val(a.getFullYear());$("#MedicationSchedulerFormStartMonth").val(a.getMonth()+1);$("#MedicationSchedulerFormStartDay").val(a.getDate());handleStartDateChange();hideDosageError()}$(document).on("change",".start_date_row select",function(){handleStartDateChange()});
function handleStartDateChange(){var a=$("#MedicationSchedulerFormStartYear"),b=$("#MedicationSchedulerFormStartMonth"),c=$("#MedicationSchedulerFormStartDay"),d=a.val(),e=b.val(),a=c.val();""===d?(b.prop("disabled",!0),e="",b.val(e)):b.prop("disabled",!1);""===e?(c.prop("disabled",!0),c.val("")):c.prop("disabled",!1);if(""!=d&&""!=e){b=(new Date(d,e,0)).getDate();c.empty();c.append($("<option></option>").val("").html("Day"));for(d=1;d<=b;d++)c.append($("<option>Day</option>").val(d).html(d));a<=
b?c.val(a):c.val("")}}$(document).ready(function(){var a=getUserNow(),a=new Date(a.getFullYear(),a.getMonth(),a.getDate(),0,0,0,0);$("#MedicationSchedulerFormEndDate").datepicker({dateFormat:"mm/dd/yy",defaultDate:a,onClose:function(){$(this).valid()}});applyTimePicker($("#new_time input"));$.validator.addMethod("greaterThanOrEqualTo",function(a,c,d){c=!1;return c=""===a||""===d?!0:new Date(new Date(a))>=new Date(new Date(d))})});
function addTimeValidation(){$("#MedicationSchedulerFormTime").rules("add",{required:!0,regex:/(([0-9]|[1][012])\:[03]0\s(a|p)m)$/i,messages:{required:"Please select time.",regex:"Please enter a valid time."}})}function removeTimeValidation(){$("#MedicationSchedulerFormTime").rules("remove","required regex")}
function addTimeRow(a){var b;""!==$("#last_time_row_index").val()?(b=$("#last_time_row_index").val(),b=parseInt(b)+1):b=0;var c=$("#sample_time_row .medication_time_row").clone(),d=c.find("input"),e=d.attr("name"),f=d.attr("id"),e=e.replace("index",b),f=f.replace("Index",b);d.attr("name",e);d.attr("id",f);d.val(a);c.find(".medication_time").html(a);$("#selected_times").append(c);$("#selected_times").addClass("facelist");$("#last_time_row_index").val(b)}
function showMedicationTimeError(a){$("#medication_time_error").html(a).removeClass("hide").addClass("help-block").show();$("#medication_time_error").parents(".form-group").addClass("error")}function hideMedicationTimeError(){$("#medication_time_error").html("").addClass("hide").removeClass("help-block").hide();$("#medication_time_error").parents(".form-group").removeClass("error")}
function applyTimePicker(a){a.timepicker({forceRoundTime:!0,showDuration:!0,timeFormat:"g:i a"}).on("selectTime",function(){hideMedicationTimeError();var a=$(this).val();isAlreadySelectedTime(a)?showMedicationTimeError("This time is already selected."):(addTimeRow(a),$("#MedicationSchedulerFormTime").val(""))})}function isAlreadySelectedTime(a){var b=$("input.hidden_medication_time").map(function(){if(""!==this.value)return this.value}).get();return-1<$.inArray(a,b)?!0:!1}
$(document).on("keyup","#MedicationSchedulerFormTime",function(){""===$(this).val()&&hideMedicationTimeError()});var medicationCache={},medicineIdField;
$(document).on("focus","#MedicationSchedulerFormMedicineName",function(){medicineIdField=$("#MedicationSchedulerFormMedicineId");var a=this;$(a).autocomplete({minLength:2,source:function(a,c){var d=$.trim(a.term);d in medicationCache?c(medicationCache[d]):$.ajax({url:"/api/searchTreatments",dataType:"json",data:{term:d},success:function(a){medicationCache[d]=a;c(a)}})},select:function(a,c){c.item&&medicineIdField.val(c.item.id)},search:function(a){if(!0===a.ctrlKey)return!1;medicineIdField.val("")},
change:function(){0<medicineIdField.val()||$(a).val("")},response:function(b,c){0===c.content.length&&(medicineIdField.val(""),$(a).val(""))}})});$(document).on("click","#remind_until_cancelled",function(){changeEndDateInputStatus();$(this).is(":checked")&&$("#MedicationSchedulerFormEndDate").val("")});$(document).on("change","#MedicationSchedulerFormRepeatFrequency",function(){changeEndDateInputStatus()});
function changeEndDateInputStatus(){$("#remind_until_cancelled").is(":checked")||""===$("#MedicationSchedulerFormRepeatFrequency").val()?$("#MedicationSchedulerFormEndDate").prop("disabled",!0):$("#MedicationSchedulerFormEndDate").prop("disabled",!1)}$(document).on("click",".delete_medication_time",function(){$(this).parent(".medication_time_row").remove();0===$("#selected_times .medication_time_row").length&&$("#selected_times").removeClass("facelist")});
$(document).on("focus",'input[name="data[MedicationSchedulerForm][time]"]',function(){removeTimeValidation()});
$(document).on("click","#save_medication_schedule",function(){var a=$('input[name="data[MedicationSchedulerForm][time]"]'),b;b=0<$("#selected_times input").length?""===$("#MedicationSchedulerFormTime").val()?!1:!0:!0;!0===b?addTimeValidation():removeTimeValidation();var c=$('input[name="data[MedicationSchedulerForm][end_date]"]');if($("#remind_until_cancelled").is(":checked"))c.rules("remove","required, greaterThanOrEqualTo");else{var d=getStartDateValue();c.rules("add",{required:!0,greaterThanOrEqualTo:d,
messages:{required:"Please select the date to stop medication.",greaterThanOrEqualTo:"Stop date cannot be less than start date."}})}c=$("#medication_scheduler_form").valid();!0===b?(b=a.valid(),!0===b&&(a=a.val(),isAlreadySelectedTime(a)?(b=!1,showMedicationTimeError("This time is already selected.")):(b=!0,hideMedicationTimeError()))):b=!0;a=isMedicationDosageValid(!0);c&&(b&&a)&&saveMedicationSchedule()});$(document).on("keyup","#MedicationSchedulerFormDosage",function(){isMedicationDosageValid()});
$(document).on("change","#MedicationSchedulerFormDosageUnit",function(){isMedicationDosageValid()});
function isMedicationDosageValid(a){var b=!1,c="";""===$("#MedicationSchedulerFormDosage").val()||""===$("#MedicationSchedulerFormDosageUnit").val()?(b=!1,c="Please enter dose of medicine.",""===$("#MedicationSchedulerFormDosage").val()?!0===a&&$("#MedicationSchedulerFormDosage").parent(".form-group").addClass("error"):$("#MedicationSchedulerFormDosage").parent(".form-group").removeClass("error"),""===$("#MedicationSchedulerFormDosageUnit").val()?!0===a&&$("#MedicationSchedulerFormDosageUnit").parent(".form-group").addClass("error"):
$("#MedicationSchedulerFormDosageUnit").parent(".form-group").removeClass("error")):(b=$("#MedicationSchedulerFormDosage").val(),isNaN(b)||0>=b?(b=!1,c="Please enter a valid dose.",!0===a&&$("#MedicationSchedulerFormDosage").parent(".form-group").addClass("error")):(b=!0,$("#MedicationSchedulerFormDosage").parent(".form-group").removeClass("error")));!1===b?!0===a&&showDosageError(c):hideDosageError();return b}
function showDosageError(a){$(".dose_row").addClass("error");$(".dose_row .error_span").html(a).removeClass("hide")}function hideDosageError(){$(".dose_row").removeClass("error");$(".dose_row .error_span").html("").addClass("hide")}function getStartDateValue(){var a=$("#MedicationSchedulerFormStartYear").val(),b=$("#MedicationSchedulerFormStartMonth").val(),c=$("#MedicationSchedulerFormStartDay").val(),d="";""!==a&&(""===b&&(b=1),""===c&&(c=1),d=b+"/"+c+"/"+a);return d}
function saveMedicationSchedule(){var a=Ladda.create(document.querySelector("#save_medication_schedule"));$.ajax({type:"POST",url:"/user/scheduler/save",data:$("#medication_scheduler_form").serialize(),dataType:"json",beforeSend:function(){a.start();$("#save_medication_schedule").prop("disabled",!0);$("#cancel_medication_schedule").prop("disabled",!0)},success:function(b){!0===b.success?($("#save_medication_schedule").prop("disabled",!0),$("#cancel_medication_schedule").prop("disabled",!0),b.refresh?
location.reload():(a.stop(),$("#medication_scheduler_dialog").modal("hide"),b.content?$("#medication_schedules").html(b.content):bootbox.alert(b.message))):!0===b.error&&(a.stop(),$("#save_medication_schedule").prop("disabled",!1),$("#cancel_medication_schedule").prop("disabled",!1),bootbox.alert(b.message,function(){b.errorType&&"fatal"===b.errorType&&(window.location.reload(),window.scrollTo(0,0))}))}})}
$(document).on("click",".medication_section .month_prev, .medication_section .month_next",function(){var a=$(this).attr("data-date");$.ajax({type:"POST",url:"/user/myhealth/getMedicationsOnDate",data:{date:a},beforeSend:function(){var a=$("#medication_loading").clone();a.removeClass("hide");$("#medication_schedules").html(a)},success:function(a){$("#medication_schedules").html(a);var c=$("#hidden_medication_data_form"),a=c.find("#medication_date").val(),d=c.find("#next_date").val(),c=c.find("#prev_date").val();
$(".medication_section .selected_date").html(a);$(".medication_section .month_next").attr("data-date",d);$(".medication_section .month_prev").attr("data-date",c)}})});$(document).on("click","#select_all_medications",function(){$(this).is(":checked")?$('input[type="checkbox"]').prop("checked",!0):$('input[type="checkbox"]').prop("checked",!1)});
$(document).on("click","#delete_medication_btn",function(){if(0<$('tbody input[type="checkbox"]:checked').length)bootbox.confirm("Deleting the selected medication(s) will remove all reminders and medication history of those medications. \n\t\tIf you are no longer taking these medication(s), change the stop date to the day you stopped taking the medication. \n\t\tThis way you will not receive reminders, but will keep a record of your medication history.\n\t\tIf you still want to delete the selected medications, click 'OK' button.",function(a){a&&
(a=$("#medications_form").serialize(),$.ajax({url:"/user/scheduler/deleteMedications",type:"POST",data:a}),$('tbody input[type="checkbox"]:checked').closest("tr").remove(),$("tbody tr").removeClass("alternative_row"),$("tbody tr").each(function(a){0===a%2&&$(this).addClass("alternative_row")}))});else return bootbox.alert("Please select any medication."),!1});
$(document).on("click","a.edit_medication",function(){var a=$(this).closest("tr");clearMedicationScheduleForm();var b=a.find('input[type="checkbox"]').val(),c=a.find(".medication_type").html(),d=a.find(".medication_id").val(),e=a.find(".dosage").val(),f=a.find(".dosage_unit").val(),h=a.find(".indication").text(),i=a.find(".amount").html(),j=a.find(".additional_instructions").text(),k=a.find(".prescribed_by").text(),l=a.find(".medication_form").val(),m=a.find(".route").val(),n=a.find(".frequency").val(),
o=a.find(".start_year").val(),p=a.find(".start_month").val(),q=a.find(".start_day").val(),g=a.find(".end_date").val();$("#MedicationSchedulerFormId").val(b);$("#MedicationSchedulerFormMedicineName").val(c);$("#MedicationSchedulerFormMedicineId").val(d);$("#MedicationSchedulerFormDosage").val(e);$("#MedicationSchedulerFormDosageUnit").val(f);$("#MedicationSchedulerFormIndication").val(h);$("#MedicationSchedulerFormAmount").val(i);$("#MedicationSchedulerFormAdditionalInstructions").val(j);$("#MedicationSchedulerFormPrescribedBy").val(k);
$("#MedicationSchedulerFormForm").val(l);$("#MedicationSchedulerFormRoute").val(m);$("#MedicationSchedulerFormRepeatFrequency").val(n);$("#MedicationSchedulerFormStartYear").val(o);$("#MedicationSchedulerFormStartMonth").val(p);$("#MedicationSchedulerFormStartDay").val(q);handleStartDateChange();""!==g&&($("#MedicationSchedulerFormEndDate").val(g),$("#MedicationSchedulerFormEndDate").prop("disabled",!1),$("#remind_until_cancelled").prop("checked",!1));a.find(".time_list").each(function(){var a=$(this).val();
parseInt(a[0])===0&&(a=a.replace("0",""));addTimeRow(a)});$("#medication_scheduler_dialog").find(".modal-title.add_title").addClass("hide");$("#medication_scheduler_dialog").find(".modal-title.edit_title").removeClass("hide");$("#medication_scheduler_dialog").modal("show")});$(document).on("click",".scheduler_print",function(){window.open("/healthinfo/print?graphIds=20","_blank")});