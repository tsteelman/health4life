(function(a){a.fn.extend({facelist:function(b,c){var d="string"==typeof b,c=a.extend({},a.Autocompleter.defaults,{url:d?b:null,data:d?null:b,delay:d?a.Autocompleter.defaults.delay:10,max:c?10:150,intro_text:"Type in the box"},c);c.highlight=c.highlight||function(a){return a};return this.each(function(){new a.Autocompleter(this,c)})},result:function(a){return this.bind("result",a)},search:function(a){return this.trigger("search",[a])},flushCache:function(){return this.trigger("flushCache")},setOptions:function(a){return this.trigger("setOptions",
[a])},unautocomplete:function(){return this.trigger("unautocomplete")}});a.Autocompleter=function(b,c){function d(b){c.data+=","+b;c.data=(new String(b)).split(",").sort().toString();l.find("#bit-"+(new String(b)).replace(/ /g,"_")).remove();a("#"+c.result_field).val(new String(a("#"+c.result_field).val().replace(b,"")));g();return!1}function f(){var f=n.selected();if(f&&""!=m.find("ul").get()&&""==m.find("ul#no_result").get()){var h=f.data;list_users=(new String(c.data)).replace(/ /g,"_");c.data=
list_users.replace(h[1],"");a("#"+c.result_field).val(a("#"+c.result_field).val()+","+h[1]);g();var k=f.data;a(".token").removeClass("token_selected");elemLI=a('<li id="bit-'+(new String(k[1])).replace(/ /g,"_")+'" class="token"><span><span><span><span>'+k[0]+"</span></span></span></span></li>").click(function(){a(".token").removeClass("token_selected");a(this).addClass("token_selected")},function(){a(this).removeClass("token_selected")});elemA=a('<span class="x"> .x</span>').click(function(){d(k[1]);
0===a(".token").length&&a(b).attr("placeholder",a(b).data("placeholder"));return!1});a(elemLI).append(elemA);m.find("ul").remove();e.parent(".token-input").before(elemLI);e.val("");""!==a(b).attr("placeholder")&&a(b).data("placeholder",a(b).attr("placeholder"));a(b).attr("placeholder","");e.focus();return!0}return!1}function g(){for(var d=a("#"+c.result_field).val(),d=d.split(","),e=0,g="",e=0;e<d.length;e++)""!=d[e]&&(g+=d[e],g+=",");a("#"+c.result_field).val(g);a("#"+c.result_field).trigger("change");
""!==g&&a(b).closest(".form-group-col").find("span.help-block").remove()}function h(b){1==b?valor=e.val().substring(0,e.val().length-1):valor=e.val();var d=valor.toLowerCase(),b=i,g=k,d=d.toLowerCase(),f=s.load(d);m.html('<div class="default">Searching...</div>');"string"==typeof c.url?(b=-1==c.url.indexOf("?")?"?":"&",b=c.url+b+"q="+encodeURI(d),j&&j.abort(),j=a.get(b,function(b){for(var e=[],b=b.split("\n"),g=0;g<b.length;g++){var f=a.trim(b[g]);f&&(f=f.split("|",2),e[e.length]={data:f,value:f[0],
result:c.formatResult&&c.formatResult(f,f[0])||f[0]})}b=e;s.add(d,b);i(d,b);0==b.length&&(m.html('<div class="default">No Results Found</div>'),a("#"+c.result_field).prev().val(""))})):(f=s.load(d))&&f.length?b(d,f):g(d)}function k(){a(".default").remove();m.find("ul").remove();m.append('<ul id="no_result"><li>'+c.no_result+"</li></ul>")}function i(a,b){""!=a&&b&&b.length&&q?(n.display(b,a),n.show()):m.find("ul").remove()}var e=a(b).attr("autocomplete","off"),l=a(b).closest(".facelist"),m=l.next(".result_list"),
j;e.click(function(){a(".default").remove();""!==a(b).attr("placeholder")&&a(b).data("placeholder",a(b).attr("placeholder"));a(b).attr("placeholder","");m.append('<div class="default">'+c.intro_text+"</div>");m.css("display","")});a("body").click(function(){a(".result_list ul").remove()});l.click(function(){e.focus()});e.focusout(function(){0===a(".token").length&&a(b).attr("placeholder",a(b).data("placeholder"));a(".default").remove()});var o,s=a.Autocompleter.Cache(c),q=0,n=a.Autocompleter.Select(c,
b,f,{mouseDownOnSelect:!0});e.keydown(function(g){switch(g.keyCode){case 38:g.preventDefault();n.visible()?n.prev():h(0,!0);break;case 40:g.preventDefault();n.visible()?n.next():h(0,!0);break;case 33:g.preventDefault();n.visible()?n.pageUp():h(0,!0);break;case 34:g.preventDefault();n.visible()?n.pageDown():h(0,!0);break;case 9:case 13:f()&&g.preventDefault();break;case 8:arr_user=a("#"+c.result_field).val().split(",");data_tag=new String(arr_user[arr_user.length-2]);""==e.val()&&l.find("#bit-"+data_tag)&&
"token token_selected"==l.find("#bit-"+data_tag).attr("class")?d(arr_user[arr_user.length-2]):""==e.val()&&l.find("#bit-"+arr_user[arr_user.length-2])&&"token token_selected"!=l.find("#bit-"+arr_user[arr_user.length-2]).attr("class")?(a(".token").removeClass("token_selected"),l.find("#bit-"+data_tag).addClass("token_selected")):1==e.val().length?(m.find("ul").remove(),m.find("div").remove(),""!==a(b).attr("placeholder")&&a(b).attr("placeholder",a(b).data("placeholder")),m.append('<div class="default">'+
c.intro_text+"</div>")):h(1,!0);break;case 27:n.hide();m.find("ul").remove();e.val("");e.blur();a("#composeMessage").modal("hide");break;default:clearTimeout(o),o=setTimeout(h,c.delay)}}).keypress(function(){}).focus(function(){q++}).blur(function(){q=0}).click(function(){1<q++&&!n.visible()&&h(0,!0)}).bind("search",function(){}).bind("flushCache",function(){s.flush()}).bind("setOptions",function(b,d){a.extend(c,d);"data"in d&&s.populate()}).bind("unautocomplete",function(){n.unbind();e.unbind()})};
a.Autocompleter.defaults={minChars:1,delay:400,cacheLength:1,max:100,selectFirst:!0,width:0,highlight:function(a,c){return a.replace(RegExp("(?![^&;]+;)(?!<[^<>]*)("+c+")(?![^<>]*>)(?![^&;]+;)","gi"),"<em>$1</em>")},intro_text:"Type in the box",result_field:"to_users",no_result:"No user result"};a.Autocompleter.Cache=function(b){function c(a,c){h>b.cacheLength&&f();g[a]||h++;g[a]=c}function d(){if(!b.data)return!1;var d={},g=0;b.url||(b.cacheLength=1);d[""]=[];for(var e=0,f=b.data.length;e<f;e++){var h=
b.data[e],h="string"==typeof h?[h]:h,j=new String(h);if(!1!==j){var o=j.charAt(0).toLowerCase();d[o]||(d[o]=[]);h={value:j,data:h,result:b.formatResult&&b.formatResult(h)||j};d[o].push(h);g++<b.max&&d[""].push(h)}}a.each(d,function(a,d){b.cacheLength++;c(a,d)})}function f(){g={};h=0}var g={},h=0;setTimeout(d,25);return{flush:f,add:c,populate:d,load:function(c){if(!b.cacheLength||!h)return null;var d=[],e;for(e in g)0<e.length&&a.each(g[e],function(a,b){var g=b.value.toLowerCase().indexOf(c);-1!=g&&
d.push(b)});return d}}};a.Autocompleter.Select=function(b,c,d,f){function g(a){for(a=a.target;a&&"LI"!=a.tagName;)a=a.parentNode;return!a?[]:a}function h(a){i.slice(e,e+1).removeClass();e+=a;0>e?e=i.size()-1:e>=i.size()&&(e=0);i.slice(e,e+1).addClass(k.ACTIVE)}var k={ACTIVE:"auto-focus"},i,e=-1,l,m="",j=a(c).closest(".facelist").next(".result_list"),o;return{display:function(h,q){j.find("ul").remove();o=a("<ul>").appendTo(j).mouseover(function(b){g(b).nodeName&&"LI"==g(b).nodeName.toUpperCase()&&
(e=a("li",o).removeClass().index(g(b)),a(g(b)).addClass(k.ACTIVE))}).click(function(b){a(g(b)).addClass(k.ACTIVE);d();c.focus();return!1}).mousedown(function(){f.mouseDownOnSelect=!0}).mouseup(function(){f.mouseDownOnSelect=!1});0<b.width&&j.css("width",b.width);l=h;m=q;o.empty();a(".default").remove();var n=b.max&&b.max<l.length?b.max:l.length;lista=new String(b.data);new String(a("#"+b.result_field).val());for(var v=!1,r=a("#"+b.result_field).val(),r=r.split(","),p=0;p<n;p++){for(var t=!1,u=0,u=
0;u<r.length;u++)r[u]==l[p].data[1]&&(t=!0,u=r.length);!0!=t&&l[p]&&(t=new String(l[p].data[0]),!1!==t&&(v=a("<li>").html(b.highlight(t,m)).appendTo(o)[0],lista=new String(b.data),a.data(v,"ac_data",l[p]),v=!0))}!1==v&&j.html('<div class="default">No Results Found</div>');i=o.find("li");b.selectFirst&&(i.slice(0,1).addClass(k.ACTIVE),e=0)},next:function(){h(1)},prev:function(){h(-1)},pageUp:function(){0!=e&&0>e-8?h(-e):h(-8)},pageDown:function(){e!=i.size()-1&&e+8>i.size()?h(i.size()-1-e):h(8)},hide:function(){j&&
j.hide();e=-1},visible:function(){return j&&j.is(":visible")},current:function(){return this.visible()&&(i.filter("."+k.ACTIVE)[0]||b.selectFirst&&i[0])},show:function(){a(c).offset();j.css({}).show()},selected:function(){return i&&a.data(i.filter("."+k.ACTIVE)[0],"ac_data")},unbind:function(){j&&j.remove()}}};a.Autocompleter.Selection=function(a,c,d){if(a.createTextRange){var f=a.createTextRange();f.collapse(!0);f.moveStart("character",c);f.moveEnd("character",d);f.select()}else a.setSelectionRange?
a.setSelectionRange(c,d):a.selectionStart&&(a.selectionStart=c,a.selectionEnd=d);a.focus()}})(jQuery);var ROLE_PATIENT=1,ROLE_FAMILY=2,ROLE_CAREGIVER=3,ROLE_OTHER=4;function removeDobValidations(){$(".dobrow select").each(function(){$(this).rules("remove","groupRequired");$(this).rules("remove","validDOB");$(this).parents(".form-group-container").removeClass("error");$(this).valid()})}
function addDobValidations(){$(".dobrow select").each(function(){var a=parseInt($("#UserType").val())===ROLE_PATIENT?!0:!1;$(this).rules("add",{groupRequired:a,validDOB:!0,messages:{groupRequired:"Enter your date of birth",validDOB:"Minimum age limit is 13 years"}})})}$(document).on("change",".dobrow select",function(){removeDobValidations()});$(document).on("click",'#userEditForm button[type="submit"]',function(){handleCountryZipValidation($("#UserCountry"));addDobValidations();handleGenderValidation()});
function handleGenderValidation(){parseInt($("#UserType").val())===ROLE_PATIENT?$("#UserGender").rules("add",{required:!0,messages:{required:"Please select a Gender"}}):$("#UserGender").rules("remove","required")}function addDiagnosisDateValidationRule(){$.validator.addMethod("isValidDiagonisedDate",function(a,b){var c=$("#UserDob-year").val(),d=$(b).val();return 0<c&&0<d?c<=d:!0})}
function initFaceList(a){var b=$(a).next(".treatment_id_hidden").attr("id");$(a).facelist("/api/searchTreatments",properties={matchContains:!0,minChars:2,selectFirst:!1,intro_text:"Type Name",no_result:"No Names",result_field:b})}$(document).on("focus",".disease_search",function(){initDiseaseAutoComplete(this,1)});
function generate_day_select_box(a){var b=$(a).attr("data-rel"),b=(new String(b)).split("#"),c=$(a).closest(".form-group-container"),d=$(c).find("."+b[2]),f=$(c).find("."+b[1]),c=$(c).find("."+b[0]);$(a).attr("id")==c.attr("id")&&(f.prop("selectedIndex",0),d.prop("selectedIndex",0));$(a).attr("id")==f.attr("id")&&d.prop("selectedIndex",0);var a=d.val(),b=f.val(),g=c.val(),h=(new Date(g,b,0)).getDate(),c=12,k="January February March April May June July August September October November December".split(" "),
i=new Date,e=i.getMonth()+1,l=i.getDate(),i=i.getFullYear();g>=i&&(c=e);g>=i&&b>=e&&(h=l-1);if(""!=g&&""!=b){d.empty();d.append($("<option></option>").val("").html("Day"));for(g=1;g<=h;g++)d.append($("<option>Day</option>").val(g).html(g))}f.empty();f.append($("<option></option>").val("").html("Month"));for(h=1;h<=c;h++)g=h-1,f.append($("<option>Month</option>").val(h).html(k[g]));d.val(a);f.val(b)}
function createUploader(){$upload_btn=$("#bootstrapped-fine-uploader");$messages=$("#uploadmessages");$preview_div=$("#uploadPreview");$preview_img=$("#uploadPreview img");var a=new qq.FineUploaderBasic({button:$upload_btn[0],debug:!1,multiple:!1,request:{endpoint:"/user/register/photo"},validation:{acceptFiles:"image/*",allowedExtensions:["jpeg","jpg","gif","png"],minSizeLimit:"1024",sizeLimit:"5242880"},callbacks:{onError:function(a,c,d){$messages.html('<div class="alert alert-error">'+d+"</div>");
$messages.show();$upload_btn.show();$(".btn-prev").removeAttr("disabled");$(".btn-next").removeAttr("disabled");isUploading=!1},onSubmit:function(){$upload_btn.hide();$messages.show();$messages.html('<div class="alert alert-info">onSubmit</div>')},onUpload:function(a,c){$messages.html('<div class="alert alert-info">'+('<img src="'+app.site_url+'/img/loading.gif" alt="Initializing. Please hold."> Initializing "'+c+'"')+"</div>");$(".btn-prev").attr("disabled","disabled");$(".btn-next").attr("disabled",
"disabled");isUploading=!0},onProgress:function(a,c,d,f){d<f?(progress=Math.round(100*(d/f))+"% of "+Math.round(f/1024)+" kB",$messages.html('<div class="alert alert-info"><img src="'+app.site_url+'/img/loading.gif" alt="In progress. Please hold."> Uploading "'+c+'" '+progress+"</div>")):$messages.show()},onComplete:function(b,c,d){isUploading=!1;$upload_btn.show();if(d.success){$messages.hide();var f=bootbox.dialog({closeButton:!1,message:"test",title:"Profile Photo",animate:!1,buttons:{success:{label:"Accept",
className:"accept btn-success",callback:function(){$.ajax({dataType:"json",type:"POST",url:"/user/register/photo",data:{crop_image:!0,x1:$("#x1").val(),y1:$("#y1").val(),w:$("#w").val(),h:$("#h").val(),cropfileName:d.fileName},beforeSend:function(){$preview_img.attr("src",app.site_url+"theme/App/img/loading.gif")},success:function(a){$("#cropfileName").val(a.fileName);$preview_img.attr("src",a.fileUrl)}})}},cancel:{label:"Cancel",className:"btn-default",callback:function(){a.cancelAll()}}}});f.find(".modal-footer .btn-success").attr("disabled",
"disabled");b='<div class="upload_area"><img src="'+d.fileurl+'" alt="Uploaded photo" /></div>';f.find(".bootbox-body").html(b+'<div>To make adjustments, please drag around the white rectangle below. When you are happy with the photos, click "Accept" button. Your beautiful, clean, non-pixelated image should be at minimum 200x200 pixels.</div>');setTimeout(function(){var a=200;d.imageWidth<a?a=d.imageWidth-2:d.imageHeight<a&&(a=d.imageHeight-2);f.find(".bootbox-body img").imgAreaSelect({parent:".bootbox",
autoHide:!1,mustMatch:!0,handles:!0,instance:!0,aspectRatio:"1:1",x1:0,y1:0,x2:a,y2:a,minHeight:a,minWidth:a,onInit:function(){f.find(".modal-footer .btn-success").removeAttr("disabled")},onSelectStart:function(){f.find(".modal-footer .btn-success").removeAttr("disabled")},onCancelSelection:function(){f.find(".modal-footer .btn-success").attr("disabled","disabled")},onSelectEnd:function(a,b){$("#x1").val(b.x1);$("#y1").val(b.y1);$("#w").val(b.width);$("#h").val(b.height)}});$(".btn-prev").removeAttr("disabled");
$(".btn-next").removeAttr("disabled")},500)}else $messages.show(),$("#uploadmessages .alert").removeClass("alert-info").addClass("alert-error").html('Error with "'+c+'": '+d.error)}}})}
function initRegistration(){detectTimeZone();applyChosen();$(".chosen-select").chosen().change(function(){$(this).valid()});setHideShowPlugin("#UserPassword");setHideShowPlugin("#UserConfirm-password");$("#UserPassword").pwstrength();createUploader();addDiagnosisDateValidationRule();initFaceList("#PatientDisease0UserTreatments")}
function detectTimeZone(){$.ajax({url:"/api/detected_timezone_id_JSON",data:getTimeZoneData(),method:"POST",dataType:"JSON"}).done(function(a){$("#UserTimezone").val(a)})}function removeDiseaseNamesValidation(){$('[name*="[disease_name]"]').each(function(){$(this).rules("remove","required");$(this).valid()})}
$(document).on("click",".roles",function(){$(".role_container .roles").removeClass("active");$(this).addClass("active");var a=parseInt($(this).data("user_type"));$("#UserType").val(a);var b=$(this).find("h3").text()+" SignUp";$("#form_heading").text(b);var b="/theme/App/img/user_default_"+a+"_medium.png",c,d=$(".condition_row .red_star_span"),f=$(".dobrow .red_star_span"),g=$(".gender_row .red_star_span"),h=$(".diagnosis_date_row, .medication_row");if(a===ROLE_PATIENT)h.show(),d.show(),f.show(),g.show(),
a="Condition Details",c="border_patient";else{h.hide();h.each(function(){$(this).find("select, input").val("")});$(".medication_row .facelist li.token").remove();removeDiseaseNamesValidation();d.hide();f.hide();g.hide();var k;switch(a){case ROLE_OTHER:k="friend";c="border_other";break;case ROLE_CAREGIVER:k="patient";c="border_caregiver";break;case ROLE_FAMILY:k="family member",c="border_family"}a="What condition does your "+k+" have?"}$(".condition_heading").text(a);a=$("#uploadPreview img");""===
$("#cropfileName").val()&&a.attr("src",b);a.attr("class","img-circle profile_brdr_5 "+c);removeValidationErrors()});function removeValidationErrors(){removeDobValidations();$("#User").validate().resetForm();$(".form-group").removeClass("error")}$(document).on("blur",".disease_search",function(){""===$(this).next(".disease_id_hidden").val().trim()&&$(this).val("")});
$(document).on("click","#add_condition_btn",function(){var a,b;a=$("#last_condition_index").val();b=parseInt(a)+1;a=$("#sample_condition_row").clone();a.removeClass("hide").removeAttr("id");a.find("input").each(function(){var a=$(this).attr("name"),d=$(this).attr("id"),a=a.replace("index",b),d=d.replace("Index",b);$(this).attr("name",a);$(this).attr("id",d)});$("#conditions_container").append(a);$("#last_condition_index").val(b);initFaceList("#PatientDisease"+b+"UserTreatments")});
$(document).on("click",".condition_row .close",function(){$(this).closest(".condition_row").remove()});$(document).on("change",'[name*="[diagnosis_date_year]"], [name*="[treatment_id]"]',function(){if(parseInt($("#UserType").val())!==ROLE_PATIENT){var a=$(this).closest(".condition_row"),b=a.find('[name*="[disease_name]"]'),c=a.find('[name*="[diagnosis_date_year]"]'),a=a.find('[name*="[treatment_id]"]');""===c.val()&&""===a.val()&&(b.rules("remove","required"),b.valid())}});
function addDiagnosisValidations(){$(".condition_row").each(function(){var a=$(this).find('[name*="[disease_name]"]'),b=$(this).find('[name*="[diagnosis_date_year]"]');if(parseInt($("#UserType").val())===ROLE_PATIENT)a.rules("add",{required:!0,messages:{required:"Please enter a valid diagnosis"}});else{var c=$(this).find('[name*="[treatment_id]"]');""===b.val()&&""===c.val()?a.rules("remove","required"):a.rules("add",{required:!0,messages:{required:"Please select a valid diagnosis"}})}b.rules("add",
{isValidDiagonisedDate:!0,messages:{isValidDiagonisedDate:"Please enter a valid date"}})})}$(document).on("click","#terms_conditions",function(){$("#agree_check").click()});$(document).on("click","#signup_finish_btn",function(){handleGenderValidation();addDobValidations();addDiagnosisValidations();handleCountryZipValidation($("#UserCountry"));if($("#User").valid()&&!$("#registrationWizards .form-group").hasClass("error"))$("#User").submit(),$(this).prop("disabled",!0);else return!1});
$(document).on("click","#signup_cancel_btn",function(){window.location.href="/"});$(document).on("click",".signup_video",function(){showVideoPopup(this)});